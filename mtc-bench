#!/bin/bash

# If -h or --help is passed as an argument, print the help message
if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    echo "Usage: $0 [options]"
    echo "Options:"
    echo "  -h, --help    Print this help message"
    echo "  -v, --version Print the version of the benchmark"
    echo "  -d, --debug   Enable debug mode"
    exit 0
fi

# Store the provided arguments as a string in the appropriate format
HYPERFINE_ARGS=()

# Loop over the passed arguments (commands to be benchmarked)
for cmd in "$@"; do
    # Wrap each command with psrecord
    HYPERFINE_ARGS+=("psrecord --interval 0.1 --log $$.log --plot $$.png --include-children \"$cmd\"")
done

WARMUP=1
REPS=10

# Call hyperfine with the formatted arguments
hyperfine --warmup $WARMUP \
    --export-json $$.json \
    --export-asciidoc $$.txt \
    --export-markdown $$.md \
    --export-csv $$.csv \
    --max-runs $REPS \
    "${HYPERFINE_ARGS[@]}"
