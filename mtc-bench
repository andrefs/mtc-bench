#!/bin/bash

# If -h or --help is passed as an argument, print the help message
if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    echo "Usage: $0 [options]"
    echo "Options:"
    echo "  -h, --help    Print this help message"
    #echo "  -v, --version Print the version of the benchmark"
    #echo "  -d, --debug   Enable debug mode"
    exit 0
fi

RESULTS_BASE_DIR='mtc-results'
RES_DIR=${RES_DIR:-"$RESULTS_BASE_DIR/$$"}
mkdir -p "$RES_DIR"

# Loop over the passed arguments (commands to be benchmarked)
HYPERFINE_ARGS=()
for i in $(seq 1 $#); do
    # Wrap each command with psrecord
    HYPERFINE_ARGS+=("psrecord --interval 0.1 --log $RES_DIR/cmd$i-{rep}.log --plot $RES_DIR/$i-{rep}.png --include-children \"${!i}\"")
done

WARMUP=${WARMUP:-1}
REPS=${REPS:-10}

>&2 echo Running benchmark with "$REPS" repetitions on ${#HYPERFINE_ARGS[@]} commands with "$WARMUP" warm up rounds.
>&2 echo Saving results to "$RES_DIR".

# Call hyperfine with the formatted arguments
hyperfine -P rep 1 "$REPS" --warmup "$WARMUP" \
    --export-json "$RES_DIR/hyperfine.json" \
    --export-asciidoc "$RES_DIR/hyperfine.txt" \
    --export-markdown "$RES_DIR/hyperfine.md" \
    --export-csv "$RES_DIR/hyperfine.csv" \
    --max-runs "$REPS" \
    "${HYPERFINE_ARGS[@]}"

>&2 echo Done. Results saved to "$RES_DIR".
